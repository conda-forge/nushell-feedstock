From f7c5e0a6b409fe9ad39ccbddf4ee044524d33755 Mon Sep 17 00:00:00 2001
From: Darren Schroeder <343840+fdncred@users.noreply.github.com>
Date: Sat, 14 Feb 2026 14:29:13 -0600
Subject: [PATCH] Update how `$NU_LIB_DIRS` / `$env.NU_LIB_DIRS` is handled at
 startup time (#17563)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This PR changes how (really where) `NU_LIB_DIRS` and `$env.NU_LIB_DIRS`
gets set. Specifically, it was written and tested with these two use
cases in mind for packagers.

### Usecase 1 - using the `nu -I`
```nushell
❯ nu -I /home/fdncred/vouch-git:/some/path1:/some/path2 -c 'print $env.NU_LIB_DIRS;use vouch *;vouch main'
╭───┬────────────────────────────────────────────────╮
│ 0 │ /home/fdncred/.config/nushell/scripts          │
│ 1 │ /home/fdncred/.local/share/nushell/completions │
│ 2 │ /home/fdncred/vouch-git                        │
│ 3 │ /some/path1                                    │
│ 4 │ /some/path2                                    │
╰───┴────────────────────────────────────────────────╯
Usage: vouch <command>

Local Commands:
  add               Add a user to the vouched contributors list
  check             Check a user's vouch status
  denounce          Denounce a user by adding them to the vouched file
  remove            Remove a user from the vouched contributors list

GitHub integration:
  gh-check-pr         Check if a PR author is a vouched contributor
  gh-manage-by-discussion Manage contributor status via discussion comment
  gh-manage-by-issue  Manage contributor status via issue comment
```
### Usecase 2 - Using NU_LIB_DIRS
```nushell
❯ NU_LIB_DIRS=/home/fdncred/vouch-git:/some/path1:/some/path2 nu -c 'print $env.NU_LIB_DIRS;use vouch *;vouch main'
╭───┬────────────────────────────────────────────────╮
│ 0 │ /home/fdncred/.config/nushell/scripts          │
│ 1 │ /home/fdncred/.local/share/nushell/completions │
│ 2 │ /home/fdncred/vouch-git                        │
│ 3 │ /some/path1                                    │
│ 4 │ /some/path2                                    │
╰───┴────────────────────────────────────────────────╯
Usage: vouch <command>

Local Commands:
  add               Add a user to the vouched contributors list
  check             Check a user's vouch status
  denounce          Denounce a user by adding them to the vouched file
  remove            Remove a user from the vouched contributors list

GitHub integration:
  gh-check-pr         Check if a PR author is a vouched contributor
  gh-manage-by-discussion Manage contributor status via discussion comment
  gh-manage-by-issue  Manage contributor status via issue comment
```

## Release notes summary - What our users need to know

Changes how (really where) `NU_LIB_DIRS` and `$env.NU_LIB_DIRS` gets
set. Specifically. so they can be used with:
- `nu -c` like `NU_LIB_DIRS=/some/path nu -c 'print $env.NU_LIB_DIRS;use
some_module *;some_module main'`
- `nu -I /some/path -c 'print $env.NU_LIB_DIRS;use some_module
*;some_module main'`

Details
- It synchronizes `$NU_LIB_DIRS` and `$env.NU_LIB_DIRS` at startup
- Both `$NU_LIB_DIRS` and `$env.NU_LIB_DIRS` contain defaults and
user-specified paths and provided paths append to the list
- Allows backwards compatibility with `-I` `'\x1e` for path separation
as well as allows traditional `/some/path1:/some/path2` or
`/some/path1;/some/path2` for Windows.
- A little refactor to consolidate code and adjusted some tests

## Tasks after submitting
Our plan is still to deprecate `$env.NU_LIB_DIRS` in favor of const
`$NU_LIB_DIRS` but until that time, I'm hoping this little fix makes it
work for the people who need it.

- [ ] Update the
[documentation](https://github.com/nushell/nushell.github.io)
---
 src/main.rs              | 113 +++++++++++++++++++++++++--------------
 tests/integration/cli.rs |  68 ++++++++++++++++++++---
 tests/repl/test_env.rs   |   7 +--
 3 files changed, 136 insertions(+), 52 deletions(-)

diff --git a/src/main.rs b/src/main.rs
index 2e57fe2301e14..1424b0fcb5794 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -170,25 +170,9 @@ fn main() -> Result<()> {
 
     let mut default_nu_lib_dirs_path = nushell_config_path.clone();
     default_nu_lib_dirs_path.push("scripts");
-    // env.NU_LIB_DIRS to be replaced by constant (below) - Eventual deprecation
-    // but an empty list for now to allow older code to work
-    engine_state.add_env_var("NU_LIB_DIRS".to_string(), Value::test_list(vec![]));
 
-    let mut working_set = nu_protocol::engine::StateWorkingSet::new(&engine_state);
-    let var_id = working_set.add_variable(
-        b"$NU_LIB_DIRS".into(),
-        Span::unknown(),
-        Type::List(Box::new(Type::String)),
-        false,
-    );
-    working_set.set_variable_const_val(
-        var_id,
-        Value::test_list(vec![
-            Value::test_string(default_nu_lib_dirs_path.to_string_lossy()),
-            Value::test_string(default_nushell_completions_path.to_string_lossy()),
-        ]),
-    );
-    engine_state.merge_delta(working_set.render())?;
+    // Parse include paths from -I flag
+    let include_paths = &parsed_nu_cli_args.include_path;
 
     let mut default_nu_plugin_dirs_path = nushell_config_path;
     default_nu_plugin_dirs_path.push("plugins");
@@ -311,27 +295,6 @@ fn main() -> Result<()> {
         Value::test_record(record! {}),
     );
 
-    start_time = std::time::Instant::now();
-    if let Some(include_path) = &parsed_nu_cli_args.include_path {
-        let span = include_path.span;
-        let vals: Vec<_> = include_path
-            .item
-            .split('\x1e') // \x1e is the record separator character (a character that is unlikely to appear in a path)
-            .map(|x| Value::string(x.trim().to_string(), span))
-            .collect();
-
-        let mut working_set = nu_protocol::engine::StateWorkingSet::new(&engine_state);
-        let var_id = working_set.add_variable(
-            b"$NU_LIB_DIRS".into(),
-            span,
-            Type::List(Box::new(Type::String)),
-            false,
-        );
-        working_set.set_variable_const_val(var_id, Value::list(vals, span));
-        engine_state.merge_delta(working_set.render())?;
-    }
-    perf!("NU_LIB_DIRS setup", start_time, use_color);
-
     start_time = std::time::Instant::now();
     // First, set up env vars as strings only
     gather_parent_env_vars(&mut engine_state, init_cwd.as_ref());
@@ -347,6 +310,78 @@ fn main() -> Result<()> {
     }
     perf!("Convert path to list", start_time, use_color);
 
+    // Set up NU_LIB_DIRS: constant = defaults + env + -I, env = env + -I
+    start_time = std::time::Instant::now();
+    {
+        /// Parse a string into a list of paths, splitting on the given separators.
+        fn parse_path_list(value: &str, separators: &[char]) -> Vec<String> {
+            value
+                .split(|c| separators.contains(&c))
+                .map(|s| s.trim().to_string())
+                .filter(|s| !s.is_empty())
+                .collect()
+        }
+
+        // Get user-set paths from NU_LIB_DIRS env var (after conversion to Values)
+        let mut user_lib_dirs: Vec<String> =
+            if let Some(val) = engine_state.get_env_var("NU_LIB_DIRS") {
+                match val {
+                    Value::List { vals, .. } => vals
+                        .iter()
+                        .filter_map(|v| v.as_str().ok())
+                        .map(|s| s.to_string())
+                        .collect(),
+                    Value::String { val, .. } => {
+                        // Split on platform-specific path separators
+                        parse_path_list(val, if cfg!(windows) { &[';'] } else { &[':'] })
+                    }
+                    _ => vec![],
+                }
+            } else {
+                vec![]
+            };
+
+        // Append paths from -I flag, which can contain multiple paths separated by :, ;, or \x1e for backwards compatibility
+        if let Some(spanned) = include_paths {
+            let paths = parse_path_list(&spanned.item, &[':', ';', '\x1e']);
+            user_lib_dirs.extend(paths);
+        }
+
+        // Combine default paths with user-set paths
+        let default_paths = vec![
+            default_nu_lib_dirs_path.to_string_lossy().to_string(),
+            default_nushell_completions_path
+                .to_string_lossy()
+                .to_string(),
+        ];
+        let all_lib_dirs: Vec<String> = default_paths.into_iter().chain(user_lib_dirs).collect();
+
+        // Convert to Value list for setting env vars and constants
+        let all_lib_dir_values: Vec<Value> = all_lib_dirs
+            .iter()
+            .map(|s| Value::string(s.clone(), Span::unknown()))
+            .collect();
+
+        // Set $env.NU_LIB_DIRS to the full list (defaults + user-set)
+        engine_state.add_env_var(
+            "NU_LIB_DIRS".to_string(),
+            Value::list(all_lib_dir_values.clone(), Span::unknown()),
+        );
+
+        // Set $NU_LIB_DIRS as a constant with the same full list
+        let mut working_set = nu_protocol::engine::StateWorkingSet::new(&engine_state);
+        let var_id = working_set.add_variable(
+            b"$NU_LIB_DIRS".into(),
+            Span::unknown(),
+            Type::List(Box::new(Type::String)),
+            true, // is_const
+        );
+        working_set
+            .set_variable_const_val(var_id, Value::list(all_lib_dir_values, Span::unknown()));
+        engine_state.merge_delta(working_set.render())?;
+    }
+    perf!("$env.NU_LIB_DIRS/$NU_LIB_DIRS setup", start_time, use_color);
+
     engine_state.add_env_var(
         "NU_VERSION".to_string(),
         Value::string(env!("CARGO_PKG_VERSION"), Span::unknown()),
